load("//tools/build_rules:java_rules.bzl", "java_test")

java_library(
    name = "bazel",
    srcs = glob([
        "src/main/java/**/*.java",
    ]),
    licenses = ["LICENSE"],
    plugins = [
        "//third-party/java/auto:auto_value_processor",
    ],
    required_for_source_only_abi = True,
    visibility = ["PUBLIC"],
    deps = [
        "//third-party/java/auto:auto_value_annotations",
        "//third-party/java/errorprone:error-prone-annotations",
        "//third-party/java/gson:gson",
        "//third-party/java/guava:guava",
        "//third-party/java/jsr:jsr305",
        "//third-party/java/objenesis:objenesis",
        "//third-party/java/protobuf:protobuf",
        "//third-party/java/protobuf:protobuf-util",
    ],
)

java_test(
    name = "tests",
    srcs = glob(
        [
            "src/test/java/**/*.java",
        ],
        exclude = [
            "src/test/java/net/starlark/java/annot/processor/testsources/**/*.java",
            # This test does not work on Windows for unknown reason,
            # but we don't really care because
            # * we don't have local patches to Starlark
            # * we don't use annotation processor
            "src/test/java/net/starlark/java/annot/processor/StarlarkMethodProcessorTest.java",
        ],
    ),
    resources = glob([
        "src/test/java/net/starlark/java/annot/processor/testsources/**/*.java",
    ]),
    resources_root = "src/test/java",
    deps = [
        ":bazel",
        "//third-party/java/compile-testing:compile-testing",
        "//third-party/java/errorprone:error-prone-annotations",
        "//third-party/java/guava:guava",
        "//third-party/java/jsr:jsr305",
        "//third-party/java/junit:junit",
        "//third-party/java/protobuf:protobuf",
        "//third-party/java/truth:truth",
    ],
)
